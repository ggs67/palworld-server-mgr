# MIT License and Disclaimer

Copyright 2024 by Gaston Gloesener

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the “Software”), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

# Introduction

This is a script to automatically manage the Palworld dedicated server in order to save resources if not used. The script waits for a connection by a client before it starts the server. The server remains then active until a specified time (usually in the night) at which it will be shutdown again.

# Prerequisites

The script has been tested on Ubuntu 22.04 but should also work on other distributions as long as they are more or less up-to-date and systemd based. The install script also exects

## Required commands

The following commands must be available on the server system:
- systemctl (systemd)
- socat
# Palworld server setup

## Initial setup

The script expects a Steam Palworld server V1.5+ to be setup according to the description below (link) with the exception of installing the service file into /etc/systemd . This file will be generated by install.sh

[Setting up a dedicated Palworld Server on Ubuntu]([Setting up a Palworld Server on Ubuntu - Pi My Life Up](https://pimylifeup.com/ubuntu-palworld-dedicated-server/))

## Additional setup

### Setup PalWorld server RCON

In addition to the documentation above you have to enable the RCON server. This is done by editing the PalWorldSettings.ini file created during the setup and change the following settings:

- AdminPassword="password" # replace the word password by the password of your choice
- RCONEnabled=True
- RCONPort=25575 # This is not effective in V1.5  (the script passes it via command line)

### Edit server manager config

Edit palworld_server_mgr.conf config file and adjust the settings to your installation. As a minimum RCON_PASS must be adjusted to your AdminPassword set in the previous step.

### Add steam to sudo group

The sudo command must be available on the system and user `steam`added to the sudo group to allow the service installation to work and allow steam user to start and stop the service. 

To add steam to the sudo group execute the following command using `root` user:

```groupmems -a steam -g sudo
```

> [!WARNING]
> I expect this script to be mostly used for private systems. For systems where security is a concern you may want to add a special more restrictive rules to the sudoers to allow only the required commands
### Install the service

#### Configuration service file

The service installer configuration file install.conf allows to configure the service name and options.

Please note that the service name must be specified without the trailing ".service" and if it is changed after the service has been installed, the old service must be removed manually !!!

While the options may be added here as a bash array, it may be easier to just specify the options on the install.sh script command line (after a --) , this will
automatically update the config file as well

#### Install

The script install.sh should be run once. It will download the rcon-cli binary for use by the server manager and install the PalWorld service in systemd

#### Installation parameters

>[!NOTE] Synopsis
>./install.sh \<install-options\> [-- \<service-options\>]

##### Install options:

- -R : deinstall service
- -S : install original server service (not using pal server manager)
- -w : install palworld-worldoptions

##### palworld-worldoptions

see: [github.com/legoduded/palworld-worldoptions](https://github.com/legoduded/palworld-worldoptions)

PalWorld dedicated server fails to load some settings (like currently `BaseCampWorkerMaxNum`) from the servers ini file while it was found that these are loaded from an optional UE save file.

Michael Phelan (aka. legoduded) has release a tool on github that can generate such a save file from an existing ini file (link above).

This tool can be automatically installed (in private, not system directory) using the -w option on the install.sh script. This will also install the required uesave-re repository.

Now editing the ini file using the server manager (i.e. -c option) will also generate the corresponding WorldOption.sav file.

>[!IMPORTANT] Credits
>Full credits for the palworld-worldoptions tool go to Michael Phelan (aka. legoduded) for the tool and to Truman Kilen (aka. trumank) for the uesave-rs tool used by palworld-worldoptions to write the save file
##### Service flags

Flags added after a -- are directly passed on to the server manager service.
See `./palworld_server_mgr -h` for details and which options can be passed
to the service.


> [!NOTE]
> run `./palworld_server_mgr.sh -h` in order to get usage help
## Start service

```sudo systemctl start palworld
```

## Stop service

```sudo systemctl stop palworld
```

> [!NOTE]
> Note that stopping this service will also shutdown any started PalWorld server

> [!NOTE]
> The stop command may hang up to 5 minutes! In the worst case the service will required 1 minute to detect the shutdown signal allowing 2 minutes for ordinary shutdown. And an additional 2 minutes if SIGHUP/SIGKLILL has to be used (see [Details about shutdown])
> 
> I will try to workaround the 1 minute delay limitation without impacting performance

# Details about shutdown

When `systemctl stop` is used. a SHUTDOWN command is send to the service which is only received if currently no PalWorld server is running. In this case the service will imediatally exit.

Otherwise systemd will send a SIGTERM to the service which will be detected as soon as the 60 second sleep is ending. The service waits for 60 seconds then checks if shutdown time has been reached and at the same time allows for shutdown signal catching.

The shutdown process for `systemctl stop` and reaching of shutdown time is the same with the exception that the latter grants a delay of SHUTDOWN_DELAY (configured in config file) for users to logoff, while `systemctl stop` uses virtually no delay.

The shutdown process first attempts to send a "ShutDown" command to the server using RCON allowing it 2 minutes to shutdown. If the server did exit or this timeout did elapse without the the server exiting a cleanup process is started to make sure all processes did exit.

The cleanup process will start by sending a SIGHUP to any PalServer process still allowing some gracefull exit. If this still fails to shutdown the process a SIGKILL will be additionally send to force exit.

In the unlikely event that SIGKILL would also fail the service will exit !

SIGHUP and SIGKILL takes 1 minute per process if both fail. Allowing 45 seconds for SIGHUP and 15 for SIGKILL

# PalWorld server updates

The service definition includes an automatic PalWorld server update check whenever the palworld service is started or restarted.

In addition to this server updates can be triggered at a fix time every day via the SERVER_UPDATE_TIME, or can be triggered via `./palworld_server_mgr -U`
either by the steam or root user.

Note that if you attempt to trigger an update by any other user using the -U flag, you will most probably get a "permission denied" error trying to create the update semaphore and no update will be triggered. 